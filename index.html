<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Service Matcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Basic animation for the loader */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Custom scrollbar for the results table */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
        <!-- Header Section -->
        <div>
            <h1 class="text-3xl font-bold text-slate-900">CSV Service Matcher</h1>
            <p class="mt-2 text-slate-600">Upload two CSV files. The tool will find service names from the second file within the 'Summary' column of the first file and merge the data.</p>
        </div>

        <!-- File Upload Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-200">
            <!-- JIRA CSV Input -->
            <div>
                <label for="jira-file" class="block text-sm font-medium text-slate-700 mb-1">1. Upload JIRA CSV</label>
                <p class="text-xs text-slate-500 mb-2">Must contain a "Summary" column.</p>
                <input type="file" id="jira-file" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors duration-200"/>
            </div>
            <!-- Services CSV Input -->
            <div>
                <label for="services-file" class="block text-sm font-medium text-slate-700 mb-1">2. Upload Services CSV</label>
                <p class="text-xs text-slate-500 mb-2">Must contain a "Service0" column.</p>
                <input type="file" id="services-file" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-colors duration-200"/>
            </div>
        </div>
        
        <!-- Action Button -->
        <div class="flex justify-center pt-4">
            <button id="process-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-200 hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:scale-100">
                Process Files
            </button>
        </div>

        <!-- Error and Loading Section -->
        <div id="status-container" class="text-center p-4"></div>

        <!-- Results Section -->
        <div id="results-container" class="hidden space-y-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-4 border-t border-slate-200">
                 <h2 class="text-2xl font-bold text-slate-900">Merged Data</h2>
                 <button id="download-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform duration-200 hover:scale-105">
                    Download Merged CSV
                </button>
            </div>
            <p id="summary-text" class="text-sm text-slate-600"></p>
            <div class="table-container w-full overflow-x-auto border border-slate-200 rounded-lg max-h-[50vh]">
                <table id="results-table" class="w-full text-sm text-left text-slate-600">
                    <!-- Table content will be generated by JavaScript -->
                </table>
            </div>
        </div>

    </div>

    <script>
        // DOM element references
        const jiraFileInput = document.getElementById('jira-file');
        const servicesFileInput = document.getElementById('services-file');
        const processBtn = document.getElementById('process-btn');
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');
        const downloadBtn = document.getElementById('download-btn');
        const resultsTable = document.getElementById('results-table');
        const summaryText = document.getElementById('summary-text');
        
        let mergedData = [];
        let mergedHeaders = [];

        // --- Core Functions ---

        /**
         * Parses CSV text into an array of objects.
         * It intelligently finds the header row by looking for a key column.
         * @param {string} text - The CSV content as a string.
         * @param {string} keyColumn - A column name that is expected to be in the header.
         * @returns {Array<Object>} An array of objects representing rows.
         */
        const parseCSV = (text, keyColumn) => {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length === 0) return [];

            let headerLineIndex = -1;
            let header = [];

            // Search for the header row in the first 10 lines of the file
            const searchLimit = Math.min(lines.length, 10);
            for (let i = 0; i < searchLimit; i++) {
                // Clean up potential header values
                const potentialHeader = lines[i].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                if (potentialHeader.includes(keyColumn)) {
                    headerLineIndex = i;
                    header = potentialHeader;
                    break;
                }
            }

            // If no header is found, we can't process the file
            if (headerLineIndex === -1) {
                return [];
            }

            const rows = lines
                .slice(headerLineIndex + 1)
                .map(line => {
                    // Ignore empty lines which might be present in the CSV
                    if (line.trim() === '') return null;

                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                    const rowObject = {};
                    header.forEach((col, index) => {
                        // Create object properties, skipping columns with no header name
                        if (col) {
                           rowObject[col] = values[index];
                        }
                    });
                    return rowObject;
                })
                .filter(row => row !== null); // Remove the empty lines we marked as null

            return rows;
        };
        
        /**
         * Reads a file and returns its content as text.
         * @param {File} file - The file to read.
         * @returns {Promise<string>} A promise that resolves with the file content.
         */
        const readFileAsText = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file);
            });
        };

        /**
         * Merges JIRA and Services data based on the matching logic.
         * @param {Array<Object>} jiraData - Parsed JIRA CSV data.
         * @param {Array<Object>} servicesData - Parsed Services CSV data.
         * @returns {{mergedData: Array<Object>, matchesFound: number}} The merged data and match count.
         */
        const processData = (jiraData, servicesData) => {
            let matchesFound = 0;
            const processedData = jiraData.map(jiraRow => {
                const newRow = { ...jiraRow };
                const summary = (jiraRow['Summary'] || '').toLowerCase();
                let matchFoundForRow = false;

                if (summary) {
                    for (const serviceRow of servicesData) {
                        const serviceName = (serviceRow['Service0'] || '').toLowerCase();
                        if (serviceName && summary.includes(serviceName)) {
                            // Match found, extend the JIRA row with service data
                            Object.assign(newRow, serviceRow);
                            matchesFound++;
                            matchFoundForRow = true;
                            break; // Stop after the first match for this JIRA row
                        }
                    }
                }
                return newRow;
            });
            return { mergedData: processedData, matchesFound };
        };

        /**
         * Displays the merged data in an HTML table.
         * @param {Array<Object>} data - The merged data.
         * @param {Array<string>} headers - The headers for the table.
         */
        const displayTable = (data, headers) => {
            resultsTable.innerHTML = ''; // Clear previous results
            
            // Create table head
            const thead = document.createElement('thead');
            thead.className = "text-xs text-slate-700 uppercase bg-slate-50 sticky top-0";
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            resultsTable.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white border-b' : 'bg-slate-50 border-b';
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4';
                    td.textContent = row[header] || ''; // Use empty string for missing values
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            resultsTable.appendChild(tbody);
        };
        
        /**
         * Converts an array of objects to a CSV string.
         * @param {Array<Object>} data - The data to convert.
         * @param {Array<string>} headers - The headers for the CSV.
         * @returns {string} The CSV content as a string.
         */
        const convertToCSV = (data, headers) => {
            const headerRow = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
            const bodyRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] === undefined || row[header] === null ? '' : String(row[header]);
                    return `"${value.replace(/"/g, '""')}"`;
                }).join(',');
            });
            return [headerRow, ...bodyRows].join('\n');
        };

        /**
         * Triggers a file download.
         * @param {string} content - The content of the file.
         * @param {string} fileName - The name of the file to download.
         * @param {string} contentType - The MIME type of the file.
         */
        const downloadFile = (content, fileName, contentType) => {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        /**
         * Sets the status message and style.
         * @param {string} message - The message to display.
         * @param {'error' | 'loading' | 'success'} type - The type of message.
         */
        const setStatus = (message, type = 'error') => {
            statusContainer.innerHTML = ''; // Clear previous status
            if (!message) return;
            
            const statusDiv = document.createElement('div');
            let classes = 'p-4 rounded-lg text-sm ';
            
            if (type === 'error') {
                classes += 'bg-red-100 text-red-700';
                statusDiv.textContent = `Error: ${message}`;
            } else if (type === 'loading') {
                classes += 'bg-blue-100 text-blue-700 flex items-center justify-center gap-3';
                const loader = document.createElement('div');
                loader.className = 'loader';
                statusDiv.appendChild(loader);
                statusDiv.append(message);
            } else { // success
                classes += 'bg-green-100 text-green-700';
                statusDiv.textContent = message;
            }
            
            statusDiv.className = classes;
            statusContainer.appendChild(statusDiv);
        };
        
        // --- Event Handlers ---

        const handleProcess = async () => {
            const jiraFile = jiraFileInput.files[0];
            const servicesFile = servicesFileInput.files[0];

            // 1. Validation
            if (!jiraFile || !servicesFile) {
                setStatus('Please select both CSV files.');
                return;
            }
            setStatus('Processing files...', 'loading');
            processBtn.disabled = true;
            resultsContainer.classList.add('hidden');

            try {
                // 2. Read and Parse Files
                const [jiraText, servicesText] = await Promise.all([
                    readFileAsText(jiraFile),
                    readFileAsText(servicesFile)
                ]);

                const jiraData = parseCSV(jiraText, 'Summary');
                const servicesData = parseCSV(servicesText, 'Service0');
                
                // 3. Check for required columns
                if (jiraData.length === 0) {
                    throw new Error('JIRA CSV is missing data or the "Summary" column could not be found.');
                }
                if (servicesData.length === 0) {
                    throw new Error('Services CSV is missing data or the "Service0" column could not be found.');
                }

                // 4. Process the data
                const { mergedData: processedData, matchesFound } = processData(jiraData, servicesData);
                mergedData = processedData; // Store globally for download

                // 5. Determine all unique headers for the final table
                const jiraHeaders = Object.keys(jiraData[0] || {});
                const servicesHeaders = Object.keys(servicesData[0] || {});
                mergedHeaders = [...new Set([...jiraHeaders, ...servicesHeaders])]; // Store globally

                // 6. Display results
                displayTable(mergedData, mergedHeaders);
                summaryText.textContent = `Processing complete. Found ${matchesFound} matches across ${jiraData.length} JIRA entries.`;
                setStatus('', 'success'); // Clear loading status
                resultsContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Processing failed:", error);
                setStatus(error.message || 'An unexpected error occurred.');
                resultsContainer.classList.add('hidden');
            } finally {
                processBtn.disabled = false;
            }
        };

        const handleDownload = () => {
            if (mergedData.length === 0) {
                setStatus('No data available to download.');
                return;
            }
            const csvContent = convertToCSV(mergedData, mergedHeaders);
            downloadFile(csvContent, 'merged_jira_data.csv', 'text/csv;charset=utf-8;');
        };

        // --- Attach Event Listeners ---
        processBtn.addEventListener('click', handleProcess);
        downloadBtn.addEventListener('click', handleDownload);
    </script>

</body>
</html>

